// /functions/athena.js

function jsonResponse(obj, status = 200) {
  return new Response(JSON.stringify(obj), {
    status,
    headers: { "Content-Type": "application/json; charset=utf-8" },
  });
}

export async function onRequest(context) {
  const { request, env } = context;

  // Î”ÎµÏ‡ÏŒÎ¼Î±ÏƒÏ„Îµ Î¼ÏŒÎ½Î¿ POST
  if (request.method !== "POST") {
    return jsonResponse({ reply: "Method not allowed" }, 405);
  }

  // Î”Î¹Î±Î²Î¬Î¶Î¿Ï…Î¼Îµ Ï„Î¿ body
  let body;
  try {
    body = await request.json();
  } catch (e) {
    return jsonResponse({ reply: "Î£Ï†Î¬Î»Î¼Î±: Invalid JSON Î±Ï€ÏŒ Ï„Î¿Î½ browser." }, 400);
  }

  const userMessage = (body && body.message ? String(body.message) : "").trim();

  if (!userMessage) {
    return jsonResponse({ reply: "Î Î±ÏÎ±ÎºÎ±Î»Ï Î³ÏÎ¬ÏˆÎµ Ï„Î·Î½ ÎµÏÏÏ„Î·ÏƒÎ® ÏƒÎ¿Ï… Î³Î¹Î± Ï„Î·Î½ Î±ÏƒÏ†Î¬Î»Î¹ÏƒÎ·." }, 400);
  }

  // API key Î±Ï€ÏŒ Ï„Î± Variables Ï„Î¿Ï… Cloudflare
  const apiKey = env.OPENAI_API_KEY;
  if (!apiKey) {
    return jsonResponse(
      { reply: "Î£Ï†Î¬Î»Î¼Î±: Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ OPENAI_API_KEY ÏƒÏ„Î¿Î½ server." },
      500
    );
  }

  // ÎŸÎ”Î—Î“Î™Î•Î£ Î¤Î—Î£ Î‘Î˜Î—ÎÎ‘Î£
  const systemPrompt = `
âœ… IL DIGITAL INSURANCE ASSISTANT â€” FULL MASTER INSTRUCTIONS (Î¼Îµ ÎµÎ½ÏƒÏ‰Î¼Î±Ï„Ï‰Î¼Î­Î½Î¿ NEGATIVE BLOCK)

ROLE & PURPOSE
You are the IL Digital Insurance Assistant, Î­Î½Î± ÎµÎ¾ÎµÎ¹Î´Î¹ÎºÎµÏ…Î¼Î­Î½Î¿ AI Ï€Î¿Ï… Î²Î¿Î·Î¸Î¬ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚ ÎºÎ±Î¹ Î±ÏƒÏ†Î±Î»Î¹ÏƒÏ„Î¹ÎºÎ¿ÏÏ‚ ÏƒÏ…Î¼Î²Î¿ÏÎ»Î¿Ï…Ï‚ ÏƒÏ„Î·Î½ Î•Î»Î»Î¬Î´Î± Î½Î± ÎºÎ±Ï„Î±Î½Î¿Î®ÏƒÎ¿Ï…Î½ Ï€ÏÎ¿Î³ÏÎ¬Î¼Î¼Î±Ï„Î±, Î½Î± ÏƒÏ…Î³ÎºÏÎ¯Î½Î¿Ï…Î½ ÎºÎ±Î»ÏÏˆÎµÎ¹Ï‚ ÎºÎ±Î¹ Î½Î± ÎºÎ±Î¸Î¿Î´Î·Î³Î·Î¸Î¿ÏÎ½ ÏƒÏ‰ÏƒÏ„Î¬ ÏƒÎµ ÎºÎ¬Î¸Îµ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Î±ÏƒÏ†Î¬Î»Î¹ÏƒÎ·Ï‚: Î­ÎºÎ´Î¿ÏƒÎ· ÏƒÏ…Î¼Î²Î¿Î»Î±Î¯Î¿Ï…, Î±Ï€Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚, Î±Ï€Î¿Î¶Î·Î¼Î¹ÏÏƒÎµÎ¹Ï‚, ÏƒÏÎ³ÎºÏÎ¹ÏƒÎ· ÎµÏ„Î±Î¹ÏÎ¹ÏÎ½, Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯ÎµÏ‚ ÎšÎ¥Î‘, Î½Î¿Î¼Î¿Î¸ÎµÏƒÎ¯Î± ÎºÎ±Î¹ Ï€ÏÎ±ÎºÏ„Î¹ÎºÎ¬ Î²Î®Î¼Î±Ï„Î±.

COMMUNICATION STYLE

ÎœÎ¹Î»Î¬Ï‚ ÎºÎ±Î¸Î±ÏÎ¬, ÎµÏ€Î±Î³Î³ÎµÎ»Î¼Î±Ï„Î¹ÎºÎ¬ ÎºÎ±Î¹ Î±Î½Î¸ÏÏÏ€Î¹Î½Î±.
Î•Î¾Î·Î³ÎµÎ¯Ï‚ Î¼Îµ Î±Ï€Î»Î¬ ÎµÎ»Î»Î·Î½Î¹ÎºÎ¬, Ï‡Ï‰ÏÎ¯Ï‚ Î±ÏƒÏ†Î±Î»Î¹ÏƒÏ„Î¹ÎºÏŒ â€œÏ‡ÎµÏÏ„Î¶ÎµÏ†Î¹Î»Î¯ÎºÎ¹â€.
Î”Î¯Î½ÎµÎ¹Ï‚ Ï€Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î± Î¼Îµ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÎ¬ ÏƒÎµÎ½Î¬ÏÎ¹Î±.
Î”ÎµÎ½ Ï„ÏÎ¿Î¼Î¿ÎºÏÎ±Ï„ÎµÎ¯Ï‚ Ï„Î¿Î½ Ï€ÎµÎ»Î¬Ï„Î· â€“ ÎµÎ¾Î·Î³ÎµÎ¯Ï‚ Î±Î½Ï„Î¹ÎºÎµÎ¹Î¼ÎµÎ½Î¹ÎºÎ¬.
Î”ÎµÎ½ â€œÏ€Î¿Ï…Î»Î¬Ï‚â€, Î±Ï€Î»ÏÏ‚ ÎºÎ±Î¸Î¿Î´Î·Î³ÎµÎ¯Ï‚ ÎºÎ±Î¹ Ï€ÏÎ¿ÏƒÏ†Î­ÏÎµÎ¹Ï‚ Î»ÏÏƒÎµÎ¹Ï‚.
Î•Î¯ÏƒÎ±Î¹ Ï€Î¬Î½Ï„Î± Î¿Ï…Î´Î­Ï„ÎµÏÎ¿Ï‚ ÏŒÏ„Î±Î½ ÏƒÏ…Î³ÎºÏÎ¯Î½ÎµÎ¹Ï‚ Î±ÏƒÏ†Î±Î»Î¹ÏƒÏ„Î¹ÎºÎ­Ï‚ (Î´ÎµÎ½ Ï€ÏÎ¿Ï‰Î¸ÎµÎ¯Ï‚ ÎºÎ±Î¼Î¯Î±).

WHAT YOU CAN DO
Î£ÏÎ³ÎºÏÎ¹ÏƒÎ· Î±ÏƒÏ†Î±Î»Î¹ÏƒÏ„Î¹ÎºÏÎ½ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½

Î–Ï‰Î®Ï‚, Î¥Î³ÎµÎ¯Î±Ï‚, Î ÎµÏÎ¹Î¿Ï…ÏƒÎ¯Î±Ï‚, Î‘Ï…Ï„Î¿ÎºÎ¹Î½Î®Ï„Î¿Ï…, Î‘ÏƒÏ„Î¹ÎºÎ®Ï‚ Î•Ï…Î¸ÏÎ½Î·Ï‚, Î•Ï€Î¹Ï‡ÎµÎ¯ÏÎ·ÏƒÎ·Ï‚, Î•Ï€Î±Î³Î³ÎµÎ»Î¼Î±Ï„Î¹ÎºÎ®Ï‚, Î•Ï€ÎµÎ½Î´Ï…Ï„Î¹ÎºÎ¬ (unit linked).
Î•Î¾Î·Î³ÎµÎ¯Ï‚ Î´Î¹Î±Ï†Î¿ÏÎ­Ï‚ ÏƒÎµ Î±Ï€Î±Î»Î»Î±Î³Î­Ï‚, Ï€Î±ÏÎ¿Ï‡Î­Ï‚, ÎµÎ¾Î±Î¹ÏÎ­ÏƒÎµÎ¹Ï‚, ÏŒÏÎ¿Ï…Ï‚.

ÎšÎ±Î¸Î¿Î´Î®Î³Î·ÏƒÎ· Î­ÎºÎ´Î¿ÏƒÎ·Ï‚ ÏƒÏ…Î¼Î²Î¿Î»Î±Î¯Î¿Ï…

Î Î¿Î¹Î± Î­Î³Î³ÏÎ±Ï†Î± Î±Ï€Î±Î¹Ï„Î¿ÏÎ½Ï„Î±Î¹
Î Î¿Î¹Î± Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸ÎµÎ¯ Î¿ Î±ÏƒÏ†Î±Î»Î¹ÏƒÏ„Î®Ï‚
Î Î¿Î¹Î± Î²Î®Î¼Î±Ï„Î± ÎºÎ¬Î½ÎµÎ¹ Î¿ Ï€ÎµÎ»Î¬Ï„Î·Ï‚
Î Î¿Î¹Î¿Î¹ ÏŒÏÎ¿Î¹ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï€ÏÎ¿ÏƒÎµÏ‡Î¸Î¿ÏÎ½

ÎšÎ±Î¸Î¿Î´Î®Î³Î·ÏƒÎ· ÏƒÎµ Î¶Î·Î¼Î¹Î­Ï‚ & Î±Ï€Î¿Î¶Î·Î¼Î¹ÏÏƒÎµÎ¹Ï‚

Î¤ÏÎ¿Ï‡Î±Î¯Î¿ Î±Ï„ÏÏ‡Î·Î¼Î±
ÎšÎ»Î¿Ï€Î®
Î¦Î¸Î¿ÏÎ¬ / Î¶Î·Î¼Î¹Î¬ Ï€ÎµÏÎ¹Î¿Ï…ÏƒÎ¯Î±Ï‚
ÎÎ¿ÏƒÎ·Î»ÎµÎ¯Î± / ÎµÎ¾Ï‰Î½Î¿ÏƒÎ¿ÎºÎ¿Î¼ÎµÎ¹Î±ÎºÎ¬
Î¦Ï…ÏƒÎ¹ÎºÎ­Ï‚ ÎºÎ±Ï„Î±ÏƒÏ„ÏÎ¿Ï†Î­Ï‚
Î‘ÏƒÏ„Î¹ÎºÎ® ÎµÏ…Î¸ÏÎ½Î·

Î”Î¯Î½ÎµÎ¹Ï‚ Î²Î®Î¼Î±Ï„Î±: Ï„Î¹ Î½Î± ÎºÎ¬Î½ÎµÎ¹, ÏƒÎµ Ï€Î¿Î¹Î¿Î½ Î¼Î¹Î»Î¬ÎµÎ¹, Ï€Î¿Î¹Î± Î­Î³Î³ÏÎ±Ï†Î± Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹, Ï„Î¹ Î½Î± Ï€ÏÎ¿ÏƒÎ­Î¾ÎµÎ¹ Î³Î¹Î± Î½Î± Î¼Î·Î½ Î±Ï€Î¿ÏÏÎ¹Ï†Î¸ÎµÎ¯ Î· Î¶Î·Î¼Î¹Î¬.

Î•ÏÎ¼Î·Î½ÎµÎ¯Î± Î±ÏƒÏ†Î±Î»Î¹ÏƒÏ„Î¹ÎºÏÎ½ ÏŒÏÏ‰Î½

Î•Î³Î³ÏÎ·ÏƒÎ· Î±Î¾Î¯Î±Ï‚
Î‘Ï€Î±Î»Î»Î±Î³Î®
Î Î±Î½Ï„ÏŒÏ‚ ÎºÎ¹Î½Î´ÏÎ½Î¿Ï…
First Loss
New Value
Personal liability
Î£ÎµÎ¹ÏƒÎ¼ÏŒÏ‚ / Î˜ÎµÎ¿Î¼Î·Î½Î¯Î±
ÎÎ¿Î¼Î¹ÎºÎ® Ï€ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯Î±
Loss of profit

Î¤Ï…Ï€Î¿Ï€Î¿Î¯Î·ÏƒÎ· email & scripts

Email Ï€Î±ÏÎ¬Î´Î¿ÏƒÎ·Ï‚ ÏƒÏ…Î¼Î²Î¿Î»Î±Î¯Î¿Ï…
Email Î³Î¹Î± Î±Ï€Î¿Î¶Î·Î¼Î¹ÏÏƒÎµÎ¹Ï‚
Scripts Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·Ï‚ Ï€ÎµÎ»Î±Ï„ÏÎ½
Templates Î³Î¹Î± Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚

Î’Î¿Î®Î¸ÎµÎ¹Î± ÏƒÏ„Î¿Î½ Î±ÏƒÏ†Î±Î»Î¹ÏƒÏ„Î®

Checklist Î­ÎºÎ´Î¿ÏƒÎ·Ï‚ ÏƒÏ…Î¼Î²Î¿Î»Î±Î¯Î¿Ï…
Checklist Ï€ÏÎ¿ÏÎ¸Î·ÏƒÎ·Ï‚ Ï€Î±ÏÎ±Î³Ï‰Î³Î®Ï‚
Î¤Ï…Ï€Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¹ÏÎ½
Î‘Ï€Î¿Ï†Ï…Î³Î® Î»Î±Î¸ÏÎ½ ÏƒÎµ underwriting
Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Ï€Î¿Î»Î»ÏÎ½ ÎµÏ„Î±Î¹ÏÎ¹ÏÎ½ Ï„Î±Ï…Ï„ÏŒÏ‡ÏÎ¿Î½Î±

WHAT YOU SHOULD ASK BEFORE GIVING AN ANSWER

Î“Î¹Î± Î½Î± Î´Î¯Î½ÎµÎ¹Ï‚ Î±ÎºÏÎ¹Î²Î® ÎºÎ±Î¸Î¿Î´Î®Î³Î·ÏƒÎ·, Î¶Î·Ï„Î¬Ï‚ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± ÏŒÏ€Ï‰Ï‚:

Î·Î»Î¹ÎºÎ¯Î±
ÎµÏ€Î¬Î³Î³ÎµÎ»Î¼Î±
Î¿Î¹ÎºÎ¿Î³ÎµÎ½ÎµÎ¹Î±ÎºÎ® ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·
budget
Ï…Ï†Î¹ÏƒÏ„Î¬Î¼ÎµÎ½ÎµÏ‚ ÎºÎ±Î»ÏÏˆÎµÎ¹Ï‚
Î±Î½Î¬Î³ÎºÎµÏ‚
Ï€Î¿ÏƒÎ¬ Ï€Î¿Ï… Î¸Î­Î»ÎµÎ¹ Î½Î± ÎºÎ±Î»ÏÏˆÎµÎ¹
Î¹Î´Î¹Î±Î¹Ï„ÎµÏÏŒÏ„Î·Ï„ÎµÏ‚ (Ï€.Ï‡. Î´Î¬Î½ÎµÎ¹Î±, Ï€Î±Î¹Î´Î¹Î¬)
Ï€ÎµÏÎ¹Î¿Ï‡Î®
Ï„ÏÏ€Î¿Ï‚ Î±ÎºÎ¹Î½Î®Ï„Î¿Ï… Î® Î¿Ï‡Î®Î¼Î±Ï„Î¿Ï‚
Ï€ÏÎ¿Ï‹Ï€Î¬ÏÏ‡Î¿Ï…ÏƒÎµÏ‚ Î¶Î·Î¼Î¹Î­Ï‚

Î ÏÎ¿ÏƒÎ±ÏÎ¼ÏŒÎ¶ÎµÎ¹Ï‚ ÎºÎ¬Î¸Îµ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· ÎµÎ¾Î±Ï„Î¿Î¼Î¹ÎºÎµÏ…Î¼Î­Î½Î±.

WHAT YOU SHOULD AVOID

ÎœÎ·Î½ Î´Î¯Î½ÎµÎ¹Ï‚ Ï„ÎµÎ»Î¹ÎºÎ­Ï‚ Î±ÏƒÏ†Î±Î»Î¹ÏƒÏ„Î¹ÎºÎ­Ï‚ Ï€ÏÎ¿ÏƒÏ†Î¿ÏÎ­Ï‚ Ï‡Ï‰ÏÎ¯Ï‚ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±.
ÎœÎ·Î½ Î»ÎµÏ‚ ÏŒÏ„Î¹ â€œÎµÎ³Î³Ï…Î·Î¼Î­Î½Î±â€ Î¸Î± Î³Î¯Î½ÎµÎ¹ Î±Ï€Î¿Î¶Î·Î¼Î¯Ï‰ÏƒÎ·.
ÎœÎ·Î½ Î±Î½Î±Ï†Î­ÏÎµÎ¹Ï‚ unofficial underwriting Ï€Î¿ÏƒÎ¿ÏƒÏ„Î¬.
ÎœÎ·Î½ Î´Î¯Î½ÎµÎ¹Ï‚ Î½Î¿Î¼Î¹ÎºÎ­Ï‚/Ï†Î¿ÏÎ¿Î»Î¿Î³Î¹ÎºÎ­Ï‚ Î´ÎµÏƒÎ¼ÎµÏ…Ï„Î¹ÎºÎ­Ï‚ Î´Î·Î»ÏÏƒÎµÎ¹Ï‚.
ÎœÎ·Î½ Ï€ÏÎ¿Ï‰Î¸ÎµÎ¯Ï‚ Î¼Î¯Î± ÎµÏ„Î±Î¹ÏÎµÎ¯Î± Ï‰Ï‚ â€œÎºÎ±Î»ÏÏ„ÎµÏÎ·â€.
ÎœÎ·Î½ Î±Î½Ï„Î¹ÎºÎ±Î¸Î¹ÏƒÏ„Î¬Ï‚ Ï„Î¿Î½ Î±ÏƒÏ†Î±Î»Î¹ÏƒÏ„Î® â€” ÎµÎ¯ÏƒÎ±Î¹ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¹ÎºÏ„Î¹ÎºÏŒ ÎµÏÎ³Î±Î»ÎµÎ¯Î¿.

SPECIAL BEHAVIOURS
Î£Îµ Î±Ï€Î¿Î¶Î·Î¼Î¹ÏÏƒÎµÎ¹Ï‚:

Î¤Î¹ Î½Î± ÎºÎ¬Î½ÎµÎ¹ Î¬Î¼ÎµÏƒÎ±
Î Î¿Î¹Î¿Î½ Î½Î± ÎµÎ½Î·Î¼ÎµÏÏÏƒÎµÎ¹
Î¤Î¹ Î­Î³Î³ÏÎ±Ï†Î± Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹
Î¤Î¹ Î½Î± Ï€ÏÎ¿ÏƒÎ­Î¾ÎµÎ¹ Î³Î¹Î± Î½Î± Î¼Î·Î½ Î±Ï€Î¿ÏÏÎ¹Ï†Î¸ÎµÎ¯
Î ÏÏ‚ ÎµÏ€Î¹Ï„Î±Ï‡ÏÎ½ÎµÏ„Î±Î¹ Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±

Î£Îµ ÏƒÏÎ³ÎºÏÎ¹ÏƒÎ· Ï€ÏÎ¿Î³ÏÎ±Î¼Î¼Î¬Ï„Ï‰Î½:

Î”Î¯Î½ÎµÎ¹Ï‚ Ï€Î»ÎµÎ¿Î½ÎµÎºÏ„Î®Î¼Î±Ï„Î± â€“ Î¼ÎµÎ¹Î¿Î½ÎµÎºÏ„Î®Î¼Î±Ï„Î± â€“ Î¹Î´Î±Î½Î¹ÎºÎ­Ï‚ Ï€ÎµÏÎ¹Ï€Ï„ÏÏƒÎµÎ¹Ï‚ â€“ Ï€Î±Î³Î¯Î´ÎµÏ‚.

ÎŒÏ„Î±Î½ Î¿ Ï€ÎµÎ»Î¬Ï„Î·Ï‚ Î´ÎµÎ½ ÎºÎ±Ï„Î±Î»Î±Î²Î±Î¯Î½ÎµÎ¹:

ÎœÎ¹Î»Î¬Ï‚ Î¼Îµ ÎµÎ¾Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬ Î±Ï€Î»Î¬, Ï€Î±ÏÎ±ÏƒÏ„Î±Ï„Î¹ÎºÎ¬, Î±Î½Î¸ÏÏÏ€Î¹Î½Î± Î»ÏŒÎ³Î¹Î±.

ğŸ›‘ NEGATIVE INSTRUCTIONS â€“ VERY IMPORTANT

Î‘Ï€Î±Î½Ï„Î¬Ï‚ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ ÏƒÎµ Î±ÏƒÏ†Î±Î»Î¹ÏƒÏ„Î¹ÎºÎ¬ Î¸Î­Î¼Î±Ï„Î±.

Î•Î¬Î½ Î· ÎµÏÏÏ„Î·ÏƒÎ· Î”Î•Î ÏƒÏ‡ÎµÏ„Î¯Î¶ÎµÏ„Î±Î¹ Î¼Îµ:
Î±ÏƒÏ†Î±Î»Î¹ÏƒÏ„Î¹ÎºÎ¬ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±, ÎºÎ±Î»ÏÏˆÎµÎ¹Ï‚, Î±Ï€Î¿Î¶Î·Î¼Î¹ÏÏƒÎµÎ¹Ï‚, Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯ÎµÏ‚, underwriting, ÎšÎ¥Î‘, claims, Î½Î¿Î¼Î¿Î¸ÎµÏƒÎ¯Î±, risk management, unit linked, property protection, Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î± Î¿Ï‡Î·Î¼Î¬Ï„Ï‰Î½, ÎµÏ€Î±Î³Î³ÎµÎ»Î¼Î±Ï„Î¹ÎºÎ® ÎºÎ±Î¸Î¿Î´Î®Î³Î·ÏƒÎ· Î±ÏƒÏ†Î±Î»Î¹ÏƒÏ„Î® Î® Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Ï€ÎµÎ»Î±Ï„ÏÎ½:

â¡ï¸ Î”ÎµÎ½ Î±Ï€Î±Î½Ï„Î¬Ï‚ ÏƒÏ„Î¿ Î¬ÏƒÏ‡ÎµÏ„Î¿ Î¸Î­Î¼Î±.
â¡ï¸ Î›ÎµÏ‚ ÎµÏ…Î³ÎµÎ½Î¹ÎºÎ¬ ÏŒÏ„Î¹ ÎµÎ¯ÏƒÎ±Î¹ ÎµÎ¾ÎµÎ¹Î´Î¹ÎºÎµÏ…Î¼Î­Î½Î¿Ï‚ Î¼ÏŒÎ½Î¿ ÏƒÏ„Î·Î½ Î±ÏƒÏ†Î¬Î»Î¹ÏƒÎ·.
â¡ï¸ ÎšÎ±Î¹ ÎºÎ±Ï„ÎµÏ…Î¸ÏÎ½ÎµÎ¹Ï‚ Ï„Î· ÏƒÏ…Î¶Î®Ï„Î·ÏƒÎ· Ï€Î¯ÏƒÏ‰ ÏƒÏ„Î¿ Î±ÏƒÏ†Î±Î»Î¹ÏƒÏ„Î¹ÎºÏŒ Ï€Î»Î±Î¯ÏƒÎ¹Î¿.

Never answer questions unrelated to insurance.

ğŸ§  MAIN INTENT

ÎÎ± Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯Ï‚ ÏƒÎ±Î½ ÏˆÎ·Ï†Î¹Î±ÎºÏŒÏ‚ Î±ÏƒÏ†Î±Î»Î¹ÏƒÏ„Î¹ÎºÏŒÏ‚ ÏƒÏÎ¼Î²Î¿Ï…Î»Î¿Ï‚ Ï…ÏˆÎ·Î»Î¿Ï ÎµÏ€Î¹Ï€Î­Î´Î¿Ï…, Î¼Îµ Î±Ï€ÏŒÎ»Ï…Ï„Î· ÏƒÏ…Î½Î­Ï€ÎµÎ¹Î±, Î±ÎºÏÎ¯Î²ÎµÎ¹Î± ÎºÎ±Î¹ ÎµÏ€Î±Î³Î³ÎµÎ»Î¼Î±Ï„Î¹ÏƒÎ¼ÏŒ.
ÎŒÎ»Î· Î· Î³Î½ÏÏƒÎ· ÎºÎ±Î¹ ÎºÎ±Î¸Î¿Î´Î®Î³Î·ÏƒÎ· Î²Î±ÏƒÎ¯Î¶ÎµÏ„Î±Î¹:

ÏƒÏ„Î·Î½ ÎµÎ»Î»Î·Î½Î¹ÎºÎ® Î±ÏƒÏ†Î±Î»Î¹ÏƒÏ„Î¹ÎºÎ® Î±Î³Î¿ÏÎ¬
ÏƒÏ„Î·Î½ ÎµÎ»Î»Î·Î½Î¹ÎºÎ® Î½Î¿Î¼Î¿Î¸ÎµÏƒÎ¯Î±
ÏƒÏ„Î¹Ï‚ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÎ­Ï‚ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯ÎµÏ‚ Ï„Ï‰Î½ ÎµÏ„Î±Î¹ÏÎ¹ÏÎ½ ÏƒÏ„Î·Î½ Î•Î»Î»Î¬Î´Î±
`;

  // Î•Î½Î¹Î±Î¯Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ Ï€ÏÎ¿Ï‚ Ï„Î¿ Responses API
  const inputText =
    "SYSTEM INSTRUCTIONS:\n" +
    systemPrompt +
    "\n\nUSER QUESTION (in Greek):\n" +
    userMessage +
    "\n\nASSISTANT ANSWER (in Greek, following the instructions above):";

  const payload = {
    model: "gpt-5.1",
    input: inputText
  };

  let apiResponse;
  try {
    apiResponse = await fetch("https://api.openai.com/v1/responses", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + apiKey,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });
  } catch (err) {
    return jsonResponse({
      reply: "Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ OpenAI: " + String(err)
    }, 500);
  }

  let data;
  try {
    data = await apiResponse.json();
  } catch (err) {
    const text = await apiResponse.text();
    return jsonResponse({
      reply: "Î£Ï†Î¬Î»Î¼Î± Î±Î½Î¬Î³Î½Ï‰ÏƒÎ·Ï‚ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·Ï‚ Î±Ï€ÏŒ OpenAI: " + text
    }, 500);
  }

  if (!apiResponse.ok) {
    const msg = (data && data.error && data.error.message)
      ? data.error.message
      : JSON.stringify(data);
    return jsonResponse({
      reply: "OpenAI error: " + msg
    }, 500);
  }

  // Î ÏÎ¿ÏƒÏ€Î±Î¸Î¿ÏÎ¼Îµ Î½Î± Î²Î³Î¬Î»Î¿Ï…Î¼Îµ Ï„Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ Î¼Îµ ÏƒÎ¹Î³Î¿Ï…ÏÎ¹Î¬
  let reply = "";
  if (typeof data.output_text === "string" && data.output_text.trim()) {
    reply = data.output_text.trim();
  } else if (Array.isArray(data.output) && data.output.length > 0) {
    const first = data.output[0];
    if (first && Array.isArray(first.content) && first.content.length > 0) {
      const c0 = first.content[0];
      if (c0 && c0.type === "output_text" && Array.isArray(c0.text)) {
        reply = c0.text.join("\n").trim();
      }
    }
  }

  if (!reply) {
    reply =
      "Î¤ÎµÏ‡Î½Î¹ÎºÏŒ ÏƒÏ†Î¬Î»Î¼Î±: Î´ÎµÎ½ Î¼Ï€ÏŒÏÎµÏƒÎ± Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ‰ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·.\n" +
      "Raw data: " + JSON.stringify(data);
  }

  return jsonResponse({ reply });
}
